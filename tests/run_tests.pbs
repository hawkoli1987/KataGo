#!/bin/bash
#PBS -N pytest_tests
#PBS -q AISG_debug
#PBS -l walltime=01:00:00
#PBS -l select=1:mem=64gb:ncpus=8:ngpus=1
#PBS -j oe
#PBS -o /dev/null

set -euo pipefail

# Create log directory with job ID
# Use realpath to resolve symlinks (container mounts require actual paths)
REPO_DIR="/scratch/Projects/SPEC-SF-AISG/source_files/KataGo"
LOG_DIR="${REPO_DIR}/runtime/log"
mkdir -p "${LOG_DIR}/${PBS_JOBID}"

# Redirect output to log file
exec >> "${LOG_DIR}/${PBS_JOBID}/test.log" 2>&1

echo "=== Test started at $(date) ==="
echo "PBS_JOBID: ${PBS_JOBID}"
echo "Hostname: $(hostname)"

# Configuration (same as enroot_start.pbs)
export SHARED_FS="/scratch/Projects/SPEC-SF-AISG"
export SQSH_DIR="${SHARED_FS}/sqsh"
export SQSH_FILE="${SQSH_DIR}/go.sqsh"
export CONTAINER_NAME="katago_dev"
export ENROOT_DATA_PATH="${SHARED_FS}/.enroot/data"
export HOST_NVIDIA_MOUNT="/opt/host-nvidia"

# CUDA driver libraries
HOST_LIBCUDA="/lib64/libcuda.so.1"
HOST_LIBNVML="/lib64/libnvidia-ml.so.1"

mkdir -p "${ENROOT_DATA_PATH}"

# Verify required files
echo "Checking required files..."
if [ ! -f "${SQSH_FILE}" ]; then
    echo "ERROR: Missing ${SQSH_FILE}. Run runtime/enroot_create.pbs first." >&2
    exit 1
fi

echo "SQSH file: ${SQSH_FILE} [OK]"
echo "libcuda: ${HOST_LIBCUDA} [$([ -f ${HOST_LIBCUDA} ] && echo OK || echo MISSING)]"

export LD_LIBRARY_PATH="${HOST_NVIDIA_MOUNT}:${LD_LIBRARY_PATH:-}"

# Create container if it doesn't exist
if ! enroot list | grep -q "^${CONTAINER_NAME}$"; then
    echo "Creating container ${CONTAINER_NAME}..."
    enroot create -n "${CONTAINER_NAME}" "${SQSH_FILE}"
fi

# Prepare container mount points
echo "Preparing container mount points..."
enroot start --root --rw \
    --mount="${HOME}:${HOME}" \
    --mount="${SHARED_FS}:${SHARED_FS}" \
  "${CONTAINER_NAME}" \
  /bin/bash -lc "mkdir -p ${HOST_NVIDIA_MOUNT}"

echo "Running pytest inside container..."

# Run tests inside the container
enroot start --root --rw \
    --env LD_LIBRARY_PATH \
    --mount="${HOME}:${HOME}" \
    --mount="${SHARED_FS}:${SHARED_FS}" \
    --mount="${HOST_LIBCUDA}:${HOST_NVIDIA_MOUNT}/libcuda.so.1" \
    --mount="${HOST_LIBNVML}:${HOST_NVIDIA_MOUNT}/libnvidia-ml.so.1" \
    --mount="/usr/bin/nvidia-smi:/usr/bin/nvidia-smi" \
  "${CONTAINER_NAME}" \
  /bin/bash -lc "
    cd ${REPO_DIR}
    export PYTHONPATH=\${PYTHONPATH}:${REPO_DIR}
    pip install -q pytest pytest-asyncio aiohttp httpx pydantic sgfmill tqdm
    python3 -m pytest tests -v
  "

echo "=== Tests completed at $(date) ==="
